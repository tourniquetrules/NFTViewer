<!DOCTYPE html>
<html>
<head>
    <title>Liberty NFT Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <h1>Liberty NFT Viewer 4.0</h1>
    <label for="walletAddress">Enter Wallet Address:</label>
    <input type="text" id="walletAddress" placeholder="0xYourWalletAddress" />
    <button onclick="fetchContractsAndNFTs()">Find My NFTs</button>
    <button onclick="generateQRCode()">Generate QR Code</button>
<div id="qrcode"></div>

    <div id="nft-list"></div>
    <script>
    function generateQRCode() {
        const wallet = document.getElementById("walletAddress").value.trim();
        const tokenId = document.getElementById("tokenId").value.trim();

        if (!ethers.utils.isAddress(wallet) || !tokenId) {
            alert("Enter a valid wallet address and Token ID first.");
            return;
        }

        const url = `https://yourwebsite.com/NFTLookup.html?wallet=${wallet}&tokenId=${tokenId}`;
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), url);
    }
</script>

    <script>
        const provider = new ethers.providers.JsonRpcProvider("https://rpc.libertyproject.space/");
        const knownContracts = [
            "0x691ea6B18cbaffB0341908b55A1431C06702F1EB", // Example contract
            "0x32124F3f053aE4Ed7BE2132b08FcCd04356D19A4"  // Another example
        ];
        const contractABI = [
            {
                "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }],
                "name": "ownerOf",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }],
                "name": "tokenURI",
                "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        async function fetchContractsAndNFTs() {
            const walletAddress = document.getElementById("walletAddress").value.trim();
            if (!ethers.utils.isAddress(walletAddress)) {
                alert("Invalid wallet address!");
                return;
            }
            
            document.getElementById("nft-list").innerHTML = "<p>Searching for contracts...</p>";
            let nftListHTML = "";
            let foundContracts = [];

            // Step 1: Identify Contracts Associated with the Address
            for (const contractAddress of knownContracts) {
                const contract = new ethers.Contract(contractAddress, contractABI, provider);
                try {
                    const balance = await contract.balanceOf(walletAddress);
                    if (balance > 0) {
                        foundContracts.push(contractAddress);
                    }
                } catch (error) {
                    console.log(`Error checking contract ${contractAddress}:`, error);
                }
            }
            
            if (foundContracts.length === 0) {
                document.getElementById("nft-list").innerHTML = "<p>No NFT contracts found for this address.</p>";
                return;
            }

            document.getElementById("nft-list").innerHTML = "<p>Fetching NFTs...</p>";
            
            // Step 2: Retrieve NFTs for Each Contract
            for (const contractAddress of foundContracts) {
                const contract = new ethers.Contract(contractAddress, contractABI, provider);
                for (let tokenId = 1; tokenId <= 100; tokenId++) { // Searches Token IDs from 1-100
                    try {
                        const owner = await contract.ownerOf(tokenId);
                        if (owner.toLowerCase() === walletAddress.toLowerCase()) {
                            const tokenURI = await contract.tokenURI(tokenId);
                            const metadataUrl = tokenURI.replace("ipfs://", "https://red-secret-guanaco-45.mypinata.cloud/ipfs/");
                            const metadata = await fetch(metadataUrl).then(res => res.json());

                            nftListHTML += `<div>
                                <h3>${metadata.name} (Token ID: ${tokenId})</h3>
                                <p>Contract Address: ${contractAddress}</p>
                                <p>${metadata.description}</p>
                                <img src="${metadata.image.replace("ipfs://", "https://red-secret-guanaco-45.mypinata.cloud/ipfs/")}" width="200px" />
                            </div>`;
                        }
                    } catch (error) {
                        console.log(`Token ID ${tokenId} does not exist in contract ${contractAddress} or error fetching.`);
                    }
                }
            }
            
            document.getElementById("nft-list").innerHTML = nftListHTML || "<p>No NFTs found for this address.</p>";
        }
    </script>
</body>
</html>
